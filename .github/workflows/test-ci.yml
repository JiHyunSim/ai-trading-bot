name: Test CI Pipeline

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'basic'
        type: choice
        options:
        - basic
        - full
        - security
        - docker

jobs:
  test-basic:
    name: Basic Pipeline Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'basic' || github.event.inputs.test_type == 'full'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install basic dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 isort
        echo "âœ… Basic dependencies installed"
    
    - name: Test basic linting
      run: |
        echo "Testing with sample Python file..."
        echo "print('Hello CI/CD')" > test_sample.py
        black --check test_sample.py || echo "Black formatting check completed"
        flake8 test_sample.py || echo "Flake8 check completed"
        isort --check-only test_sample.py || echo "Isort check completed"
        echo "âœ… Basic linting tests completed"

  test-docker:
    name: Docker Configuration Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'docker' || github.event.inputs.test_type == 'full'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Test Docker Compose syntax
      run: |
        docker-compose -f docker-compose.ci.yml config
        echo "âœ… Docker Compose configuration is valid"
    
    - name: Test basic Docker operations
      run: |
        # í…ŒìŠ¤íŠ¸ìš© ê°„ë‹¨í•œ Dockerfile ìƒì„±
        mkdir -p test-service
        cat > test-service/Dockerfile << 'EOF'
        FROM python:3.11-slim
        WORKDIR /app
        RUN echo "print('Docker test successful')" > test.py
        CMD ["python", "test.py"]
        EOF
        
        # Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸
        docker build -t test-service ./test-service/
        docker run --rm test-service
        echo "âœ… Docker build and run test completed"

  test-security:
    name: Security Configuration Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'security' || github.event.inputs.test_type == 'full'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Test Trivy installation
      run: |
        # Trivy ì„¤ì¹˜ ë° í…ŒìŠ¤íŠ¸
        sudo apt-get update
        sudo apt-get install wget apt-transport-https gnupg lsb-release
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install trivy
        
        # íŒŒì¼ ì‹œìŠ¤í…œ ìŠ¤ìº” í…ŒìŠ¤íŠ¸
        trivy fs --exit-code 0 --format table .
        echo "âœ… Security scanning test completed"

  test-environment:
    name: Environment Configuration Test  
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'full'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Test database connectivity
      run: |
        # PostgreSQL ì—°ê²° í…ŒìŠ¤íŠ¸
        sudo apt-get update
        sudo apt-get install postgresql-client
        
        PGPASSWORD=test_password psql -h localhost -U test_user -d test_db -c "SELECT version();"
        echo "âœ… PostgreSQL connection test completed"
    
    - name: Test Redis connectivity
      run: |
        # Redis ì—°ê²° í…ŒìŠ¤íŠ¸
        sudo apt-get install redis-tools
        redis-cli -h localhost ping
        echo "âœ… Redis connection test completed"

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-basic, test-docker, test-security, test-environment]
    if: always()
    
    steps:
    - name: Test Results Summary
      run: |
        echo "## ğŸ§ª CI/CD Pipeline Test Results"
        echo ""
        echo "### Test Status:"
        
        if [[ "${{ needs.test-basic.result }}" == "success" ]]; then
          echo "âœ… Basic Pipeline Test: PASSED"
        elif [[ "${{ needs.test-basic.result }}" == "skipped" ]]; then
          echo "â© Basic Pipeline Test: SKIPPED"
        else
          echo "âŒ Basic Pipeline Test: FAILED"
        fi
        
        if [[ "${{ needs.test-docker.result }}" == "success" ]]; then
          echo "âœ… Docker Configuration Test: PASSED"
        elif [[ "${{ needs.test-docker.result }}" == "skipped" ]]; then
          echo "â© Docker Configuration Test: SKIPPED"
        else
          echo "âŒ Docker Configuration Test: FAILED"
        fi
        
        if [[ "${{ needs.test-security.result }}" == "success" ]]; then
          echo "âœ… Security Configuration Test: PASSED"
        elif [[ "${{ needs.test-security.result }}" == "skipped" ]]; then
          echo "â© Security Configuration Test: SKIPPED"
        else
          echo "âŒ Security Configuration Test: FAILED"
        fi
        
        if [[ "${{ needs.test-environment.result }}" == "success" ]]; then
          echo "âœ… Environment Configuration Test: PASSED"
        elif [[ "${{ needs.test-environment.result }}" == "skipped" ]]; then
          echo "â© Environment Configuration Test: SKIPPED"
        else
          echo "âŒ Environment Configuration Test: FAILED"
        fi
        
        echo ""
        echo "### ğŸ“‹ Next Steps:"
        echo "1. Check failed tests and fix issues"
        echo "2. Configure GitHub Secrets as per CI_CD_SETUP_GUIDE.md"
        echo "3. Create develop branch and test PR workflows"
        echo "4. Set up actual service implementations"
        
        echo ""
        echo "ğŸ‰ CI/CD Pipeline configuration test completed!"